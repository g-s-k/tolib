#!/usr/bin/env python3

""" imports """
from distutils.util import strtobool
import glob
import mutagen
import os
import pathlib
import shutil
import typing

""" constants """
_lib_directory = pathlib.Path(
    os.getenv("MUSIC_LIBRARY", os.path.join(pathlib.Path.home(), "Music")))

""" helper functions """
def get_music_files(pth: pathlib.Path) -> typing.List[mutagen.FileType]:
    """get all music files in the current directory"""
    files = [mutagen.File(f) for f in os.listdir(pth) if os.path.isfile(f)]
    return [f for f in files if f is not None]

def build_dirname(f: mutagen.FileType) -> pathlib.Path:
    """make a (naively constructed) directory name from metadata in a file"""
    d = dict(f)
    rel_pth = [_lib_directory]
    # albumartist with fallback of track artist
    artist = d.get("albumartist", d.get("artist", None))
    if artist is None:
        artist = input("Enter album artist: ")
    else:
        artist = artist[0]
    rel_pth.append(artist)
    # album
    album = d.get("album", None)
    if album is None:
        album = input("Enter album name: ")
    else:
        album = album[0]
    rel_pth.append(album)
    return pathlib.Path(os.path.join(*rel_pth))

""" main function """
def main() -> None:
    # get the files
    files = get_music_files(pathlib.Path("."))
    if len(files) == 0:
        return
    # decide on a destination
    new_dir = build_dirname(files[0])
    print("\nDestination directory: {0}\n".format(new_dir))
    # check for a collision
    if os.path.exists(new_dir):
        confirm = input("\nDestination already exists. Continue? [y/N]: ")
        if not strtobool(confirm):
            return
        # remove existing mp3 files
        for mp3 in glob.glob(os.path.join(new_dir, "*.mp3")):
            os.remove(mp3)
    else:
        os.makedirs(new_dir)
    print("ok!")

""" if invoked """
if __name__ == "__main__":
    main()
